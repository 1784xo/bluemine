<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>规则配置 - 标签管理</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src="/theme/jquery/jquery-2.2.4.js"></script>
    <script src="/theme/jquery/jquery-easyui/jquery-easyui-1.5.5.7.min.js"></script>
    <script src="/theme/jquery/jquery-easyui/locale/easyui-lang-zh_CN.js"></script>
    <script src="/theme/jquery/bulemine-core.js"></script>
    <script src="/service/tag/findAll/49252889384718336?callback=loadTagTree"></script>

    <link rel="stylesheet" type="text/css" href="/theme/jquery/jquery-easyui/css/jquery-easyui.css"/>
    <link rel="stylesheet" type="text/css" href="/theme/default/css/jquery-easyui-reset.css"/>
    <link rel="stylesheet" type="text/css" href="/theme/css/style.css"/>
    <style>

        .datagrid-row-over, .datagrid-row-selected{
            background:transparent;
        }

        .datagrid-row-editing{
            background: #e6f0fa;
        }

        .tags-datagrid .datagrid-header{
            background-color: #F9F9F9;
        }

        .tags-datagrid .datagrid-header-row, .datagrid .datagrid-row {
            height: 40px;
        }

        .tags-datagrid .datagrid-cell {
            margin: 0 10px;
        }

        .tags-datagrid .tree-icon {
            display: none;
        }

        .tags-datagrid .easyui-linkbutton .l-btn-text {
            font-size: 12px;
        }

        .tags-datagrid .datagrid-body .l-btn {
            color: #006FFF;
            border: 0px;
        }

        .tags-datagrid .datagrid-body .l-btn:hover {
            background-color: transparent;
        }
    </style>
</head>
<body>
<div th:replace="/common/header::header"></div>
<div th:replace="/common/main-west::main-west(3, 301)"></div>

<div title="添加子标签" id="tag-dialog">
    <form>
        <table width="100%" cellpadding="0" cellspacing="10" border="0">
            <tbody>
            <tr>
                <td style="width: 80px; text-align: right;">父级名:</td>
                <td><span name="tagCrumbs"></span></td>
            </tr>
            <tr>
                <td style="text-align: right;">子级名:</td>
                <td><input name="tagName" style="width: 80%" class="easyui-validatebox"
                           data-options="validateOnCreate:false, validateOnBlur:true, required:true, validType:'length[1,10]'"/>
                </td>
            </tr>
            </tbody>
        </table>
    </form>
</div>

<div title="配置规则" id="rules-dialog">
    <form>
        <table width="100%" cellpadding="0" cellspacing="0" border="0">
            <tbody>
            <tr>
                <th style="width: 100px;">会话类型</th>
                <th style="width: 100px;">数据角色</th>
                <th>规则</th>
                <th style="width: 100px;"></th>
            </tr>
            <tr>
                <td>
                <span>
                    <select name="callType">
                        <option value="ALL">全部</option>
                        <option value="AUD">语音</option>
                        <option value="CMT">评论</option>
                        <option value="OL">在线</option>
                    </select>
                </span>
                </td>
                <td>
                <span>
                    <select name="roleType">
                        <option value="ALL">全部</option>
                        <option value="CSC">客服</option>
                        <option value="CUST">客户</option>
                    </select>
                </span>
                </td>
                <td>
                <span>
                <input name="ruleExps" style="width: 90%;"/>
                </span>
                </td>
                <td>
                <span>
                    <button class="rule-create">创建</button>
                </span>
                </td>
            </tr>
            </tbody>
        </table>
    </form>
</div>

<div class="main-center">
    <div class="main-center-box">
        <div class="main-center-row">
            <h2>标签管理</h2>
        </div>
        <div class="main-center-row control-group">
            <ul class="main-center-filter">
                <li>
                    <input style="width: 300px;" class="tag-select"/>
                </li>
                <li>
                    <button>查询</button>
                </li>
            </ul>
            <div class="tags-datagrid">
                <table class="easyui-treegrid" width="100%">

                </table>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" th:inline="javascript">
    //<![CDATA[

    var event_handle = {};

    bulemine.loader(function () {

        event_handle.onTagActivated = function (val) {
            var id = $(this).data('id');
            var row = tagtree.treegrid('find', id);
            bulemine.ajaxJson({
                url: "/service/tag/update",
                masking: true,
                params: {
                    data: {
                        channelId: row.channelId,
                        tagId: row.tagId,
                        activated: val
                    }
                },
                callback: function (ok, data, msg, opts) {
                    if (ok) {

                    } else {
                        alert('[ERROR]' + msg);
                    }
                }
            });
        };

        event_handle.onTagDialog = function () {
            var id = $(this).data('id');
            var row = tagtree.treegrid('find', id);
            tagdialog.find('[name="tagCrumbs"]').html(row.tagText);
            tagdialog.data('binding', row).dialog('open');
        }

        event_handle.onRuleDialog = function (){
            ruledialog.dialog('open');
        }

        var tagtree = $('.tags-datagrid .easyui-treegrid');
        tagtree.treegrid({
            data: TAGTREE_DATA,
            idField: 'tagId',
            treeField: 'tagText',
            fitColumns: true,
            onAfterEdit:function (row, change) {
                $.parser.parse($('.tags-datagrid .datagrid-row'));
            },
            onCancelEdit:function (row) {
                $.parser.parse($('.tags-datagrid .datagrid-row'));
            },
            onDblClickRow:function (row) {
                var me=$(this);
                var editingId = row[me.treegrid('options').idField];
                if(!row.customizable || me.data('editingId') == editingId){
                    return;
                }

                var panel = me.treegrid('getPanel');
                panel.find('[group="tag-edit-button"]').linkbutton('enable');

                me.treegrid('cancelEdit', me.data('editingId')).treegrid('beginEdit', editingId).data('editingId', editingId);
            },
            toolbar:[{
                group:'tag-edit-button',
                text:'save',
                iconCls:'icon-save',
                disabled:true,
                handler:function(){alert('save')}
            }, {
                group:'tag-edit-button',
                text:'cancel',
                iconCls:'icon-cancel',
                disabled:true,
                handler:function(){
                    var panel = tagtree.treegrid('getPanel');
                    panel.find('[group="tag-edit-button"]').linkbutton('disable');
                    tagtree.treegrid('cancelEdit', tagtree.data('editingId'));
                    tagtree.data('editingId', -1);
                }
            }],
            columns: [[
                {
                    field: 'tagText',
                    title: '标签',
                    width: 800,
                    editor:{
                        type:'validatebox',
                        options:{
                            validateOnCreate:false,
                            validateOnBlur:true,
                            required:true,
                            validType:'length[1,10]'
                        }
                    }
                }, {
                    field: 'rules',
                    title: '规则数',
                    width: 100,
                    editor:false,
                    formatter: function (value, row, index) {
                        return value.length;
                    }
                }, {
                    title: '配置',
                    field: 'customizable',
                    width: 100,
                    editor:false,
                    formatter: function (value, row, index) {
                        return '<a class="easyui-linkbutton button-tag" data-options="onClick:event_handle.onTagDialog" data-id="' + row.tagId + '">添加子级</a>' +
                                '<a class="easyui-linkbutton button-rule"  data-options="onClick:event_handle.onRuleDialog" data-id="' + row.tagId + '">配置规则</a>';
                    }
                }, {
                    title: '有效',
                    field: 'activated',
                    width: 100,
                    editor:false,
                    formatter: function (value, row, index) {
                        return '<input data-id="' + row.tagId + '" class="easyui-switchbutton"' + (value ? ' checked ' : '')
                                + ' data-options="onChange:event_handle.onTagActivated, width:50, height:24, onText:\'是\', offText:\'否\'"/>';
                    }
                }
            ]]
        });

        var tagform = $('#tag-dialog form');

        var tagdialog = $('#tag-dialog');
        tagdialog.dialog({
            modal: true,
            resizable: false,
            width: 500,
            closed: true,
            buttons: [{
                width: 100,
                height: 30,
                text: '确定',
                handler: function (e) {
                    if (tagform.form('validate')) {
                        var row = tagdialog.dialog('close').data('binding');
                        bulemine.ajaxJson({
                            url: "/service/tag/create",
                            masking: true,
                            params: {
                                data: {
                                    channelId: row.channelId,
                                    parentId: row.tagId,
                                    tagText: tagform.find('input[name="tagName"]').val()
                                }
                            },
                            callback: function (ok, data, msg, opts) {
                                if (ok) {
                                    tagtree.treegrid('append', {
                                        parent: row.tagId,
                                        data: [data]
                                    });
                                    $.parser.parse($('.tags-datagrid .datagrid-row'));
                                } else {
                                    alert('[ERROR]' + msg);
                                }
                            }
                        });
                        tagform.form('reset');
                    }
                }
            }, {
                width: 100,
                height: 30,
                text: '取消',
                handler: function (e) {
                    tagdialog.dialog('close');
                }
            }]
        });

        var ruledialog=$('#rules-dialog');
        ruledialog.dialog({
            modal: true,
            resizable: false,
            width: 800,
            height:600,
            closed: true,
            buttons: [{
                width: 100,
                height: 30,
                text: '取消',
                handler: function (e) {
                    ruledialog.dialog('close');
                }
            }]
        });

        $.parser.parse($('.tags-datagrid .datagrid-row'));
    });
    //]]>
</script>
</body>
</html>