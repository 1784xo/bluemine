<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>规则配置 - 标签管理</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src="/theme/jquery/jquery-ui/jquery-2.2.4.js"></script>
    <script src="/theme/jquery/jquery-ui/jquery-ui-1.11.4.js"></script>
    <script src="/theme/jquery/bulemine-core.js"></script>
    <script src="/service/tag/findAll/49252889384718336?callback=loadTagTree"></script>
    <link rel="stylesheet" type="text/css" href="/theme/jquery/jquery-ui/css/jquery-ui.css"/>
    <link rel="stylesheet" type="text/css" href="/theme/jquery/jquery-treetable/css/jquery-treetable.css"/>
    <link rel="stylesheet" type="text/css" href="/theme/dark-blue/css/jquery-ui-reset.css"/>
    <link rel="stylesheet" type="text/css" href="/theme/css/style.css"/>

    <style>
        .main-center-filter {
            border: 1px solid #DEDEDE;
        }

        #tags-tree {
            border-left: 1px solid #DEDEDE;
            border-right: 1px solid #DEDEDE;
            border-bottom: 1px solid #DEDEDE;
        }

        .treetable > tbody > tr > td > span {
            overflow: inherit;
        }
    </style>
</head>
<body>
<div th:replace="/common/header::header"></div>
<div th:replace="/common/main-west::main-west(3, '3-1')"></div>

<div id="rules-dialog" style="display: none;" title="配置规则">
    <table class="treetable" cellpadding="0" cellspacing="0" border="0">
        <tbody>
        <tr>
            <th style="width: 100px;">会话类型</th>
            <th style="width: 100px;">数据角色</th>
            <th>规则</th>
            <th style="width: 100px;"></th>
        </tr>
        <tr>
            <td>
                <span>
                    <select name="callType">
                        <option value="ALL">全部</option>
                        <option value="AUD">语音</option>
                        <option value="CMT">评论</option>
                        <option value="OL">在线</option>
                    </select>
                </span>
            </td>
            <td>
                <span>
                    <select name="roleType">
                        <option value="ALL">全部</option>
                        <option value="CSC">客服</option>
                        <option value="CUST">客户</option>
                    </select>
                </span>
            </td>
            <td>
                <span>
                <input name="ruleExps" style="width: 90%;"/>
                </span>
            </td>
            <td>
                <span>
                    <button>创建</button>
                </span>
            </td>
        </tr>
        </tbody>
    </table>
</div>
<script type="text/javascript" th:inline="javascript">
    //    <![CDATA[
    bulemine.loader(function () {
        $("#rules-dialog").dialog({
            width: 800,
            height: 500,
            autoOpen: false,
            resizable: false,
            modal: true,
            buttons: {
                '关闭': function () {
                    $(this).dialog("close");
                }
            }
        });
    });
    //    ]]>
</script>

<div class="main-center">
    <div class="main-center-box">
        <div class="main-center-row">
            <h2>标签管理</h2>
        </div>
        <div class="main-center-row control-group">
            <ul class="main-center-filter">
                <li>
                    <input style="width: 300px;" class="tag-select"/>
                </li>
                <li>
                    <button>查询</button>
                </li>
            </ul>
            <div id="tags-tree">

            </div>

            <script type="text/javascript" th:inline="javascript">
                //                <![CDATA[
                bulemine.loader(function () {


                    function saveRule(btn, call, role, exps, rule) {
                        var params = {
                            channelId: rule.channelId,
                            ruleId: rule.ruleId,
                            callType: call.val(),
                            roleType: role.val(),
                            ruleExps: exps.val()
                        };
                        bulemine.ajaxJson({
                            url: "/service/rule/update",
                            masking: true,
                            payload: 'data',
                            params: params,
                            callback: function (ok, data, msg, opts) {
                                if (!ok) {
                                    alert('[ERROR]' + msg);
                                }
                                console.log(arguments);
                            }
                        });
                    }

                    function initRuleDialog(table, tr, item, data, opts) {
                        var dialog = $('#rules-dialog');
                        dialog.find('tr.default-state').remove();
                        $.each(data.rules, function (i) {
                            console.log(this);
                            var rule = this;
                            var tr = $('<tr class="default-state" data-ruleId="' + this.ruleId + '">' +
                                    '<td><span><select name="callType" style="width:80px;"><option value="ALL">全部</option><option value="AUD">语音</option><option value="CMT">评论</option><option value="OL">在线</option></select></span></td>' +
                                    '<td><span><select name="roleType" style="width:80px;"><option value="ALL">全部</option><option value="CSC">客服</option><option value="CUST">客户</option></select></span></td>' +
                                    '<td><span><input name="ruleExps" style="width: 90%;"/></span></td>' +
                                    '<td><span><button class="rule-save">保存</button><button class="rule-remove">删除</button></span></td>' +
                                    '</tr>');
                            dialog.find('table').append(tr);

                            var call = tr.find('select[name="callType"]').val(this.callType).selectmenu();
                            var role = tr.find('select[name="roleType"]').val(this.roleType).selectmenu();
                            var exps = tr.find('input[name="ruleExps"]').val(this.ruleExps);
                            tr.find('button.rule-save').bind('click', function () {
                                saveRule(this, call, role, exps, rule);
                            });
                            tr.find('button.rule-remove').bind('click', function () {
                                console.log('remove');
                            });
                        });
                        dialog.dialog('open');
//                        console.log(arguments);
                    };

                    $("#tags-tree").treetable({
                        data: TAGTREE_DATA,
                        treeTitle: '所有标签',
                        treeMinWidth: 200,
                        treeLeft: 10,
                        treeEditor: function (table, tr, data, opts) {
                            return data.customizable;
                        },
                        expanderLeft: 20,
                        width: '100%',
                        nodeTextField: 'tagText',
                        rootText: '全部',
                        rootVisible: false,
                        rowHeight: 30,
                        expand: true,
                        afteredit: function (target, origin, record, editer, opts) {
                            if (!$.isEmptyObject(record)) {
                                bulemine.ajaxJson({
                                    url: "/service/tag/update",
                                    masking: true,
                                    payload: 'data',
                                    params: $.extend({
                                        channelId: origin.channelId,
                                        tagId: origin.tagId
                                    }, record),
                                    callback: function (ok, data, msg, opts) {
                                        if (!ok) {
                                            alert('[ERROR]' + msg);
                                        }
                                        console.log(arguments);
                                    }
                                });
                            }
                            console.log(arguments);
                        },
                        columns: [{
                            name: 'rules',
                            text: '规则数',
                            width: 100,
                            format: function (val, record) {
                                if (val == undefined)
                                    return '';
                                return val.length;
                            }
                        }, {
                            text: '操作',
                            width: 150,
                            items: [{
//                                iconCls: 'icon-new',  // Use a URL in the icon config
                                text: '添加子级',
                                handler: function (table, tr, item, data, opts) {
                                    console.log(arguments);
                                }
                            }, {
//                                iconCls: 'icon-new',  // Use a URL in the icon config
                                text: '配置规则',
                                handler: function (table, tr, item, data, opts) {
                                    initRuleDialog(table, tr, item, data, opts);
                                }
                            }]
                        }, {
                            text: '有效',
                            width: 100,
                            items: [{
                                iconCls: true,
                                format: function (table, tr, item, data, opts) {
                                    item.addClass(data.activated ? 'icon-enable' : 'icon-disable');
                                },
                                handler: function (table, tr, item, data, opts) {
                                    if (item.hasClass('icon-enable')) {
                                        data.activated = false;
                                        item.removeClass('icon-enable').addClass('icon-disable');
                                    } else {
                                        data.activated = true;
                                        item.removeClass('icon-disable').addClass('icon-enable');
                                    }
                                    bulemine.ajaxJson({
                                        url: "/service/tag/update",
                                        masking: true,
                                        payload: 'data',
                                        params: {
                                            channelId: data.channelId,
                                            tagId: data.tagId,
                                            activated: data.activated
                                        },
                                        callback: function (ok, data, msg, opts) {
                                            if (!ok) {
                                                alert('[ERROR]' + msg);
                                            }
                                            console.log(arguments);
                                        }
                                    });
                                    console.log(arguments);
                                }
                            }]
                        }]
                    });
                });
                //    ]]>
            </script>
        </div>
    </div>
</div>
</body>
</html>